{% extends "base.html" %}
{% block title %}My Wishlist{% endblock %}

{% block body_class %}wishlist-page{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-card">
    <div class="dashboard-header">
      <h2>My Wishlist</h2>
      <a href="{{ url_for('dashboard') }}" class="logout-btn">Back</a>
    </div>

    <div class="trip-cards">
      {% for item in items %}
        <div class="trip-card">
          <img src="{{ item.image }}" alt="{{ item.destination }}">
          <div class="trip-info">
            <h4>{{ item.destination }}</h4>
            <button
              class="remove-btn"
              data-id="{{ item.id }}"
              data-destination="{{ item.destination }}"
              data-image="{{ item.image }}"
              onclick="removeWishlist(this)">
              ‚ùå
            </button>
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <img src="{{ url_for('static', filename='images/empty-wishlist.png') }}" 
              alt="Empty Wishlist" class="empty-img">

          <h3>Your wishlist is feeling lonely üíõ</h3>

          <p class="empty-subtext">
            Start exploring and save your favorite places.
          </p>
          <a href="{{ url_for('explore') }}" class="auth-btn">
            Explore Destinations
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  function removeWishlist(btn) {
    const itemId = btn.dataset.id;
    const destination = btn.dataset.destination;
    const image = btn.dataset.image;

    const confirmed = confirm(
      `Are you sure you want to remove "${destination}" from your wishlist?`
    );

    if (!confirmed) return;

    btn.disabled = true;
    btn.innerText = "‚è≥";

    fetch("/wishlist/remove", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ item_id: itemId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "removed") {
        btn.closest(".trip-card").remove();
        showUndoToast(destination, image);
      } else {
        alert("Failed to remove item.");
        btn.disabled = false;
        btn.innerText = "‚ùå";
      }
    })
    .catch(() => {
      alert("Something went wrong.");
      btn.disabled = false;
      btn.innerText = "‚ùå";
    });
  }

  function showUndoToast(destination, image) {
    let toast = document.getElementById("undo-toast");
    if (!toast) {
      toast = document.createElement("div");
      toast.id = "undo-toast";
      toast.className = "undo-toast";
      document.body.appendChild(toast);
    }

    toast.innerHTML = `
      ${destination} removed.
      <span onclick="undoRemove('${destination}', '${image}')">Undo</span>
    `;

    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
    }, 5000);
  }

  function undoRemove(destination, image) {
    fetch("/wishlist/undo", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ destination: destination, image: image })
    }).then(res => res.json())
      .then(data => {
        if(data.status === "restored") {
          location.reload();
        } else {
          console.log("Remove failed");
        }
      });
  }
</script>
{% endblock %}