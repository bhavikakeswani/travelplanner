{% extends "base.html" %}

{% block title %}Explore Destinations - TravelPlanner{% endblock %}
{% block body_class %}explore-page{% endblock %}

{% block content %}
  <div class="dashboard-container">
    <div class="dashboard-card">
      
      <div class="dashboard-header">
        <h2>Explore Destinations</h2>
        <a href="{{url_for('dashboard')}}" class="logout-btn">Back</a>
      </div>

      <div class="input-group" style="margin-bottom: 10px;">
        <i class="bi bi-search"></i>
        <input
          type="text"
          id="searchInput"
          placeholder="Search destinations..."
        >
      </div>

      <div class="trip-summary">
        <h3>Popular Places</h3>
        <p id="noResults" style="display:none; text-align:center; opacity:0.7;">
          No destinations found.
        </p>

        <div class="trip-cards">

          {% for d in destinations %}
            <div class="destination-wrapper destination-card" data-name="{{ d.name | lower }}">

              <div class="trip-card">

                <div class="image-wrapper">
                  <a href="{{ url_for('itinerary', city=d.name) }}" class="trip-card-link">
                    <img src="{{ d.image }}" alt="{{ d.name }}">
                  </a>

                  <form
                    action="{{ url_for('add_to_wishlist') }}"
                    method="POST"
                    class="wishlist-form"
                  >
                    <input type="hidden" name="destination" value="{{ d.name }}">
                    <input type="hidden" name="image" value="{{ d.image }}">

                    <button
                      type="submit"
                      class="wishlist-btn"
                      onclick="event.stopPropagation()"
                      aria-label="Add to wishlist"
                    >
                      {% if d.name.lower() in wishlisted %}
                        <i class="fa-solid fa-heart filled-heart"></i>
                      {% else %}
                        <i class="fa-regular fa-heart"></i>
                      {% endif %}
                    </button>
                  </form>
                </div>

                <a href="{{ url_for('itinerary', city=d.name) }}" class="trip-card-link">
                  <div class="trip-info">
                    <h4>{{ d.name }}</h4>
                    <p>{{ d.desc }}</p>
                  </div>
                </a>

              </div>
            </div>
          {% endfor %}

        </div>
      </div>

      <div class="dashboard-actions">
        <a href="{{url_for('create_trip')}}" class="btn">Plan Your Trip</a>
      </div>

      <div class="dashboard-footer">
        Discover, dream & travel ✈️
      </div>

    </div>
  </div>
  
  <script>
    const searchInput = document.getElementById("searchInput");
    const cardsContainer = document.querySelector(".trip-cards");
    const noResults = document.getElementById("noResults");

    let timeout = null;

    searchInput.addEventListener("input", function () {
      clearTimeout(timeout);

      const query = this.value.toLowerCase().trim();

      timeout = setTimeout(() => {
        filterOrFetch(query);
      }, 400);
    });

    function filterOrFetch(query) {
      const cards = document.querySelectorAll(".destination-card");
      let matches = 0;

      cards.forEach(card => {
        const name = card.dataset.name;
        const match = name.includes(query);
        card.style.display = match ? "" : "none";
        if (match) matches++;
      });

      if (query && matches === 0) {
        fetch(`/search-destination?city=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            if (data.found) {
              createNewCard(data.name);
              noResults.style.display = "none";
            } else {
              noResults.style.display = "block";
            }
          });
      } else {
        noResults.style.display = "none";
      }
    }

    function createNewCard(city) {
      if (document.querySelector(`[data-name="${city.toLowerCase()}"]`)) return;

      const card = document.createElement("div");
      card.className = "destination-wrapper destination-card";
      card.dataset.name = city.toLowerCase();

      card.innerHTML = `
        <div class="trip-card">
          <div class="image-wrapper">
            <a href="/itinerary/${city}" class="trip-card-link">
              <img src="https://picsum.photos/seed/${city}/600/400" alt="${city}">
            </a>
          </div>
          <a href="/itinerary/${city}" class="trip-card-link">
            <div class="trip-info">
              <h4>${city}</h4>
              <p>Explore this destination</p>
            </div>
          </a>
        </div>
      `;

      cardsContainer.prepend(card);
    }
  </script>

{% endblock %}